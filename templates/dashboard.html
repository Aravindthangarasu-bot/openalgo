{% extends "base.html" %}

{% block content %}
<!-- Dashboard Header -->
<div class="mb-6 md:mb-12">
    <div class="flex flex-col lg:flex-row lg:items-start gap-4">
        <div class="flex-1">
            <h1 class="text-2xl md:text-3xl font-bold text-base-content">Trading Dashboard</h1>
            <p class="text-base-content/60 mt-1 md:mt-2 text-sm md:text-base">Overview of your trading account and
                market positions</p>
        </div>
        <!-- Master Contract Status Indicator -->
        <div
            class="flex items-center gap-2 md:gap-3 bg-base-200 rounded-lg px-3 md:px-4 py-2 md:py-3 w-fit lg:ml-auto lg:self-start">
            <span class="text-xs md:text-sm font-medium whitespace-nowrap">Master Contract:</span>
            <div class="flex items-center gap-2">
                <div id="master-contract-led" class="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-gray-400 animate-pulse">
                </div>
                <span id="master-contract-status-text" class="text-xs md:text-sm">Checking...</span>
            </div>
        </div>

        <!-- Lots Configuration REMOVED from Header -->
    </div>
</div>

<!-- Market Indices Strip -->
<!-- Market Indices Strip -->
{% if indices_data or mcx_data or stocks_data %}
<div class="mb-6 md:mb-8">
    <!-- Indices Toggle -->
    <div class="flex justify-center mb-4">
        <div class="join">
            <input class="join-item btn btn-sm btn-active" type="radio" name="indices_options" aria-label="Indices"
                checked onclick="toggleIndices('nse')" />
            <input class="join-item btn btn-sm" type="radio" name="indices_options" aria-label="Stocks"
                onclick="toggleIndices('stocks')" />
            <input class="join-item btn btn-sm" type="radio" name="indices_options" aria-label="MCX"
                onclick="toggleIndices('mcx')" />
        </div>
    </div>

    <!-- NSE/BSE Indices Container -->
    <!-- NSE/BSE Indices Container -->
    <div id="indices-nse" class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4 transition-all duration-300">
        {% for index in indices_data %}
        {% if index.data %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-3 md:p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-sm text-base-content/70">{{ index.symbol }}</h3>
                        <div class="text-lg font-bold mt-1">
                            {{ index.data.ltp | indian_number }}
                        </div>
                    </div>
                    <div class="text-right">
                        {% set change = index.data.ltp | float - index.data.prev_close | float %}
                        {% if index.data.prev_close | float > 0 %}
                        {% set pchange = (change / index.data.prev_close | float) * 100 %}
                        {% else %}
                        {% set pchange = 0.0 %}
                        {% endif %}
                        <div
                            class="text-xs font-medium {% if change > 0 %}text-success{% elif change < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                            {{ change | round(2) }}
                        </div>
                        <div
                            class="text-xs font-bold {% if change > 0 %}text-success{% elif change < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                            ({{ pchange | round(2) }}%)
                        </div>
                    </div>
                </div>
                <div class="text-[10px] text-base-content/40 mt-2 flex justify-between">
                    <span>L: {{ index.data.low | indian_number }}</span>
                    <span>H: {{ index.data.high | indian_number }}</span>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- Stocks Container (Hidden by default) -->
    <div id="indices-stocks" class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4 hidden transition-all duration-300">
        {% for stock in stocks_data %}
        {% if stock.data %}
        <div class="card bg-base-100 shadow-sm border border-base-200">
            <div class="card-body p-3 md:p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h3
                            class="font-bold text-sm text-base-content/70 whitespace-nowrap overflow-hidden text-ellipsis">
                            {{ stock.symbol }}</h3>
                        <div class="text-lg font-bold mt-1">
                            {{ stock.data.ltp | indian_number }}
                        </div>
                    </div>
                    <div class="text-right">
                        {% set change = stock.data.ltp | float - stock.data.prev_close | float %}
                        {% if stock.data.prev_close | float > 0 %}
                        {% set pchange = (change / stock.data.prev_close | float) * 100 %}
                        {% else %}
                        {% set pchange = 0.0 %}
                        {% endif %}
                        <div
                            class="text-xs font-medium {% if change > 0 %}text-success{% elif change < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                            {{ change | round(2) }}
                        </div>
                        <div
                            class="text-xs font-bold {% if change > 0 %}text-success{% elif change < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                            ({{ pchange | round(2) }}%)
                        </div>
                    </div>
                </div>
                <div class="text-[10px] text-base-content/40 mt-2 flex justify-between">
                    <span>L: {{ stock.data.low | indian_number }}</span>
                    <span>H: {{ stock.data.high | indian_number }}</span>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- MCX Container (Hidden by default) -->
    <div id="indices-mcx" class="grid grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4 hidden transition-all duration-300">
        {% for index in mcx_data %}
        {% if index.data %}
        <div class="card bg-base-100 shadow-sm border border-base-200 mcx-card cursor-pointer hover:shadow-md transition-shadow"
            data-commodity="{{ index.display_name or index.symbol }}"
            onclick="showExpirySelector('{{ index.display_name or index.symbol }}', '{{ index.symbol }}')">
            <div class="card-body p-3 md:p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <!-- Use display_name (e.g., "Crudeoil") if available -->
                        <h3
                            class="font-bold text-xs text-secondary mb-1 whitespace-nowrap overflow-hidden text-ellipsis">
                            {{ index.symbol }}</h3>
                        <div class="text-lg font-bold mt-1 text-xl">
                            {{ index.data.ltp | indian_number }}
                        </div>
                    </div>
                    <div class="text-right">
                        {% set change = index.data.ltp | float - index.data.prev_close | float %}
                        {% if index.data.prev_close | float > 0 %}
                        {% set pchange = (change / index.data.prev_close | float) * 100 %}
                        {% else %}
                        {% set pchange = 0.0 %}
                        {% endif %}
                        <div
                            class="text-sm {% if change > 0 %}text-success{% elif change < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                            {{ change | round(2) }}
                        </div>
                        <div
                            class="text-sm font-medium {% if change > 0 %}text-success{% elif change < 0 %}text-error{% else %}text-base-content/60{% endif %}">
                            ({{ pchange | round(2) }}%)
                        </div>
                    </div>
                </div>
                <!-- Show commodity name and expiry selector hint -->
                <div class="text-[10px] text-secondary/40 mt-2 flex justify-between items-center font-mono">
                    <span>{{ index.display_name or index.symbol }}</span>
                    <span class="text-primary text-xs">▼ Select Expiry</span>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</div>

<script>
    function toggleIndices(type) {
        const nse = document.getElementById('indices-nse');
        const stocks = document.getElementById('indices-stocks');
        const mcx = document.getElementById('indices-mcx');

        // Hide all first
        nse.classList.add('hidden');
        stocks.classList.add('hidden');
        mcx.classList.add('hidden');

        // Show selected
        if (type === 'nse') nse.classList.remove('hidden');
        else if (type === 'stocks') stocks.classList.remove('hidden');
        else if (type === 'mcx') mcx.classList.remove('hidden');
    }
</script>
{% endif %}

<!-- Stats Grid -->
<div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 mb-8 md:mb-16">
    <!-- Available Balance -->
    <div class="stat-card">
        <div class="stat">
            <div class="stat-title">Available Balance</div>
            <div class="stat-value text-primary">
                {{ margin_data.get('availablecash', '0.00')|indian_number }}
            </div>
            <div class="stat-desc mt-2">
                <div class="badge badge-neutral">Cash Balance</div>
            </div>
        </div>
    </div>

    <!-- Collateral -->
    <div class="stat-card">
        <div class="stat">
            <div class="stat-title">Collateral</div>
            <div class="stat-value text-secondary">
                {{ margin_data.get('collateral', '0.00')|indian_number }}
            </div>
            <div class="stat-desc mt-2">
                <div class="badge badge-neutral">Total Collateral</div>
            </div>
        </div>
    </div>

    <!-- Unrealized P&L -->
    <div class="stat-card">
        <div class="stat">
            <div class="stat-title">Unrealized P&L</div>
            <div
                class="stat-value {% if margin_data.get('m2munrealized', '0.00')|float > 0 %}text-success{% elif margin_data.get('m2munrealized', '0.00')|float < 0 %}text-error{% else %}text-neutral{% endif %}">
                {{ margin_data.get('m2munrealized', '0.00')|indian_number }}
            </div>
            <div class="stat-desc mt-2">
                <div
                    class="badge {% if margin_data.get('m2munrealized', '0.00')|float > 0 %}badge-success{% elif margin_data.get('m2munrealized', '0.00')|float < 0 %}badge-error{% else %}badge-neutral{% endif %}">
                    Mark to Market
                </div>
            </div>
        </div>
    </div>

    <!-- Realized P&L -->
    <div class="stat-card">
        <div class="stat">
            <div class="stat-title">Realized P&L</div>
            <div
                class="stat-value {% if margin_data.get('m2mrealized', '0.00')|float > 0 %}text-success{% elif margin_data.get('m2mrealized', '0.00')|float < 0 %}text-error{% else %}text-neutral{% endif %}">
                {{ margin_data.get('m2mrealized', '0.00')|indian_number }}
            </div>
            <div class="stat-desc mt-2">
                <div
                    class="badge {% if margin_data.get('m2mrealized', '0.00')|float > 0 %}badge-success{% elif margin_data.get('m2mrealized', '0.00')|float < 0 %}badge-error{% else %}badge-neutral{% endif %}">
                    Booked P&L
                </div>
            </div>
        </div>
    </div>

    <!-- Utilised Margin -->
    <div class="stat-card">
        <div class="stat">
            <div class="stat-title">Utilised Margin</div>
            <div class="stat-value text-accent">
                {{ margin_data.get('utiliseddebits', '0.00')|indian_number }}
            </div>
            <div class="stat-desc mt-2">
                <div class="badge badge-accent">Used Margin</div>
            </div>
        </div>
    </div>
</div>

<!-- Signal Logs Grid (5 Windows) -->
<div class="mb-4">
    <h2 class="text-xl font-bold mb-4">Signal Terminals</h2>

    <!-- Channels Config Warning -->
    {% if not telegram_status.is_running %}
    <div class="alert alert-warning mb-4">
        <span>Listener is not running. Please configure channels in .env and restart.</span>
        <a href="{{ url_for('telegram_signal_bp.config') }}" class="btn btn-sm">Configure</a>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Render Configured Channels (Up to 5) -->
        {% set channels = telegram_status.channels or [] %}
        {% for i in range(5) %}
        {% set channel_name = channels[i] if i < channels|length else 'Empty Slot' %} {% set is_active=i <
            channels|length %} <div class="card bg-base-100 shadow-xl border border-base-200">
            <div class="card-header p-3 border-b border-base-200 flex justify-between items-center bg-base-200/50">
                <span class="font-bold text-sm" id="title-window-{{ i+1 }}">
                    {{ channel_name }}
                </span>
                <span class="badge badge-xs {{ 'badge-success' if is_active else 'badge-neutral' }}"
                    id="status-window-{{ i+1 }}">
                    {{ 'Active' if is_active else 'Idle' }}
                </span>
            </div>
            <div class="card-body p-0 h-64 overflow-y-auto bg-base-300 font-mono text-xs" id="log-window-{{ i+1 }}">
                <div class="p-2 text-base-content/40">
                    {{ 'Waiting for signals...' if is_active else 'Slot available for configuration' }}
                </div>
            </div>
    </div>
    {% endfor %}

    <!-- Broker Connection (Kept) -->
    <div class="card bg-base-100 shadow-xl border border-base-200">
        <div class="card-body">
            <h2 class="card-title flex justify-between">
                <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    Broker
                </div>
                <div class="badge {{ 'badge-success' if session.broker else 'badge-neutral' }}">
                    {{ 'CONNECTED' if session.broker else 'NOT CONNECTED' }}
                </div>
            </h2>
            <div class="py-4">
                {% if session.broker %}
                <div class="text-lg font-bold">{{ session.broker|title }}</div>
                {% else %}
                <div class="text-sm">Please log in to your broker.</div>
                {% endif %}
            </div>

            <!-- Lots Configuration (Moved Here) -->
            <div class="mt-4 pt-4 border-t border-base-200">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Trading Lots Multiplier:</span>
                    <input type="number" id="trading-lots-input" class="input input-sm input-bordered w-20 text-center"
                        min="1" max="100" value="1" onchange="updateTradingLots(this.value)">
                </div>
                <div class="text-xs text-base-content/40 mt-1 text-right">Applies to all auto-orders</div>
            </div>

            <div class="card-actions justify-end mt-4">
                {% if not session.broker %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-sm">Connect</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<script>

    // Define socket variable in script scope
    let socket;

    // Signal Terminal Logic
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Socket (io is available now)
        socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 10
        });

        socket.on('connect', () => console.log('✅ Socket Connected!'));

        // Map configured channels to windows (Order Matters!)
        // In real app, we might want to fetch this list from backend
        // For now, first 5 unique channels seen will claim the windows.
        const channelMap = new Map();
        let nextWindowIdx = 1;
        const MAX_WINDOWS = 5;

        // Function to assign window to a channel
        function getWindowId(channelName) {
            if (!channelMap.has(channelName)) {
                if (nextWindowIdx <= MAX_WINDOWS) {
                    channelMap.set(channelName, nextWindowIdx);
                    // Update Title
                    document.getElementById(`title-window-${nextWindowIdx}`).textContent = channelName;
                    // Clear initial "Waiting..." text
                    document.getElementById(`log-window-${nextWindowIdx}`).innerHTML = '';
                    nextWindowIdx++;
                } else {
                    console.warn(`No windows left for channel: ${channelName}`);
                    return null;
                }
            }
            return channelMap.get(channelName);
        }

        // Initialize map from rendered titles
        for (let i = 1; i <= MAX_WINDOWS; i++) {
            const titleEl = document.getElementById(`title-window-${i}`);
            if (titleEl) {
                const channelName = titleEl.textContent.trim();
                // Map configured channels to their window ID
                if (channelName && channelName !== 'Empty Slot') {
                    channelMap.set(channelName, i);
                    console.log(`Mapped '${channelName}' to Window ${i}`);
                }
            }
        }

        // Helper to append log
        function appendLog(windowId, data) {
            const { message, parsed, status, timestamp } = data;
            const logContainer = document.getElementById(`log-window-${windowId}`);
            if (!logContainer) return;

            // Check if "Waiting for signals..." is present and remove it
            const initialText = logContainer.querySelector('.text-base-content\\/40');
            if (initialText) initialText.remove();

            // Deduplication Key: Use timestamp or a hash of message if no timestamp
            const tsKey = timestamp || message.substring(0, 20); // Fallback

            // Check if already exists in this container
            if (logContainer.querySelector(`[data-ts="${tsKey}"]`)) {
                return; // Duplicate found, skip
            }

            // Time formatting (Fix: Parse ISO string)
            const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

            const logEntry = document.createElement('div');
            logEntry.className = 'p-2 border-b border-base-content/10 hover:bg-base-content/5 transition-colors';
            logEntry.setAttribute('data-ts', tsKey); // Set ID for deduplication

            let content = `<div class="flex justify-between items-center mb-1">
                <span class="text-[10px] opacity-50 font-mono">${time}</span>
                ${status === 'parsed' ? '<span class="badge badge-xs badge-success">SIG</span>' : ''}
             </div>`;

            content += `<div class="whitespace-pre-wrap break-words text-xs mb-1 font-mono">${message}</div>`;

            if (status === 'parsed' && parsed) {
                // Build signal display parts
                let signalParts = [];

                if (parsed.action) {
                    signalParts.push(`<span class="text-primary font-bold">${parsed.action}</span>`);
                }

                if (parsed.symbol) {
                    signalParts.push(`<span class="font-bold">${parsed.symbol}</span>`);
                }

                if (parsed.strike) {
                    signalParts.push(`<span class="text-warning">${parsed.strike}</span>`);
                }

                if (parsed.option_type) {
                    signalParts.push(`<span class="text-info">${parsed.option_type}</span>`);
                }

                if (parsed.price) {
                    signalParts.push(`<span>@ ${parsed.price}</span>`);
                }

                if (parsed.sl) {
                    signalParts.push(`<span class="text-error">SL ${parsed.sl}</span>`);
                }

                if (parsed.tgt) {
                    signalParts.push(`<span class="text-success">TGT ${parsed.tgt}</span>`);
                }

                // Only show parsed section if we have at least some data
                if (signalParts.length > 0) {
                    content += `<div class="mt-1 text-[10px] bg-base-200 p-1 rounded font-mono border border-base-content/10 flex gap-2 flex-wrap">
                        ${signalParts.join(' ')}
                    </div>`;
                }
            }

            logEntry.innerHTML = content;
            // Prepend (Newest at top)
            if (logContainer.firstChild) {
                logContainer.insertBefore(logEntry, logContainer.firstChild);
            } else {
                logContainer.appendChild(logEntry);
            }
        }

        // Fetch History
        async function fetchHistory() {
            try {
                const response = await fetch('/telegram-signal/history');
                const historyMap = await response.json();

                Object.keys(historyMap).forEach(channel => {
                    const windowId = channelMap.get(channel);
                    if (windowId) {
                        const signals = historyMap[channel];
                        // Reverse iteration for correct Prepend order
                        for (let i = signals.length - 1; i >= 0; i--) {
                            appendLog(windowId, signals[i]);
                        }
                    }
                });
            } catch (e) {
                console.error("Failed to fetch history", e);
            }
        }

        fetchHistory();
        // Auto-Refresh Polling (Every 1 Second)
        setInterval(fetchHistory, 1000);

        // Socket Listener
        if (typeof socket !== 'undefined') {
            socket.on('new_signal', (data) => {
                const { channel } = data;
                let windowId = channelMap.get(channel);

                if (windowId) {
                    appendLog(windowId, data);

                    // Animate Status
                    const statusBadge = document.getElementById(`status-window-${windowId}`);
                    if (statusBadge) {
                        statusBadge.className = 'badge badge-xs badge-success animate-pulse';
                        statusBadge.textContent = 'Data';
                        setTimeout(() => {
                            statusBadge.className = 'badge badge-xs badge-success';
                            statusBadge.textContent = 'Active';
                        }, 500);
                    }
                } else {
                    console.warn(`Signal received from unmapped channel: ${channel}`);
                }
            });
        }
    });

    // Master Contract Status LED Controller (Kept)
    class MasterContractStatus {
        constructor() {
            this.led = document.getElementById('master-contract-led');
            this.statusText = document.getElementById('master-contract-status-text');
            this.checkInterval = null;
            this.init();
        }

        init() {
            this.checkStatus();
            this.checkInterval = setInterval(() => this.checkStatus(), 5000);
            if (typeof socket !== 'undefined') {
                socket.on('master_contract_download', (data) => {
                    this.handleWebSocketUpdate(data);
                });
            }
        }

        async checkStatus() {
            if (window.sessionExpired) return;
            try {
                const response = await fetch('/api/master-contract/status', {
                    headers: { 'Accept': 'application/json' }
                });
                if (response.status === 401) {
                    if (typeof window.handleSessionExpiry === 'function') window.handleSessionExpiry();
                    return;
                }
                const data = await response.json();
                this.updateDisplay(data);
            } catch (error) {
                this.updateDisplay({ status: 'error', message: 'Failed to check status' });
            }
        }

        handleWebSocketUpdate(data) {
            this.checkStatus();
        }

        updateDisplay(data) {
            const { status, total_symbols } = data;
            this.led.classList.remove('animate-pulse', 'animate-spin');
            switch (status) {
                case 'success':
                    this.led.className = 'w-3 h-3 rounded-full bg-green-500';
                    this.statusText.textContent = total_symbols ? `Ready (${total_symbols} symbols)` : 'Ready';
                    this.statusText.className = 'text-sm text-green-600';
                    if (this.checkInterval) { clearInterval(this.checkInterval); this.checkInterval = null; }
                    break;
                case 'downloading':
                    this.led.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
                    this.statusText.textContent = 'Downloading...';
                    this.statusText.className = 'text-sm text-yellow-600';
                    break;
                default:
                    this.led.className = 'w-3 h-3 rounded-full bg-gray-400';
                    this.statusText.textContent = 'Unknown';
            }
        }
    }

    // ===== MCX Expiry Selector Feature =====
    const mcxExpirySelections = JSON.parse(localStorage.getItem('mcxExpirySelections')) || {};

    async function showExpirySelector(commodityName, currentSymbol) {
        event.stopPropagation();
        console.log('[EXPIRY] Opening selector for:', commodityName);

        try {
            const response = await fetch(`/api/mcx/expiries/${commodityName}`);
            if (!response.ok) {
                alert('Failed to load expiries');
                return;
            }

            const data = await response.json();
            const activeExpiries = data.expiries.filter(e => e.is_active);

            if (activeExpiries.length === 0) {
                alert('No active expiries available');
                return;
            }

            let html = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeExpirySelector()">
                    <div class="bg-base-100 rounded-lg p-6 max-w-md w-full m-4" onclick="event.stopPropagation()">
                        <h3 class="text-lg font-bold mb-4">${commodityName} - Select Expiry</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
            `;

            activeExpiries.forEach(expiry => {
                const isSelected = mcxExpirySelections[commodityName] === expiry.symbol;
                html += `
                    <div class="flex items-center p-3 rounded border ${isSelected ? 'border-primary bg-primary/10' : 'border-base-300'} cursor-pointer hover:bg-base-200"
                         onclick="selectExpiry('${commodityName}', '${expiry.symbol}', '${expiry.display_name}')">
                        <div class="flex-1">
                            <div class="font-medium">${expiry.display_name}</div>
                            <div class="text-xs text-base-content/60">${expiry.expiry_date} ${expiry.is_nearest ? '(Nearest)' : ''}</div>
                        </div>
                        ${isSelected ? '<div class="text-primary">✓</div>' : ''}
                    </div>
                `;
            });

            html += `
                        </div>
                        <div class="mt-4 flex justify-end">
                            <button class="btn btn-sm" onclick="closeExpirySelector()">Close</button>
                        </div>
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.id = 'expiry-selector-modal';
            modal.innerHTML = html;
            document.body.appendChild(modal);

        } catch (error) {
            console.error('[EXPIRY] Error:', error);
            alert('Error loading expiries');
        }
    }

    function selectExpiry(commodityName, symbol, displayName) {
        mcxExpirySelections[commodityName] = symbol;
        localStorage.setItem('mcxExpirySelections', JSON.stringify(mcxExpirySelections));
        closeExpirySelector();
        console.log(`✓ ${commodityName} switched to ${displayName}`);
        if (typeof refreshPrices === 'function') refreshPrices();
    }

    function closeExpirySelector() {
        const modal = document.getElementById('expiry-selector-modal');
        if (modal) modal.remove();
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!window.masterContractStatus) {
            window.masterContractStatus = new MasterContractStatus();
        }
    });
    async function refreshDashboardPrices() {
        try {
            const response = await fetch('/api/dashboard/prices');
            if (response.ok) {
                const data = await response.json();

                // Update Indices
                const indicesCards = document.querySelectorAll('#indices-nse .card');
                if (data.indices && indicesCards.length > 0) {
                    data.indices.forEach(function (item, i) {
                        if (indicesCards[i]) {
                            const priceElem = indicesCards[i].querySelector('.text-lg.font-bold');
                            const pctChangeElem = indicesCards[i].querySelector('.text-sm.font-medium');

                            if (priceElem) {
                                priceElem.textContent = parseFloat(item.lp).toFixed(2);
                            }

                            if (pctChangeElem) {
                                const pc = parseFloat(item.pc);
                                pctChangeElem.textContent = '(' + (pc >= 0 ? '+' : '') + pc.toFixed(2) + '%)';
                                pctChangeElem.className = 'text-sm font-medium ' + (pc >= 0 ? 'text-success' : 'text-error');
                            }
                        }
                    });
                }

                // Update Stocks
                const stocksCards = document.querySelectorAll('#indices-stocks .card');
                if (data.stocks && stocksCards.length > 0) {
                    data.stocks.forEach(function (item, i) {
                        if (stocksCards[i]) {
                            const priceElem = stocksCards[i].querySelector('.text-lg.font-bold');
                            const pctChangeElem = stocksCards[i].querySelector('.text-sm.font-medium');

                            if (priceElem) {
                                priceElem.textContent = parseFloat(item.lp).toFixed(2);
                            }

                            if (pctChangeElem) {
                                const pc = parseFloat(item.pc);
                                pctChangeElem.textContent = '(' + (pc >= 0 ? '+' : '') + pc.toFixed(2) + '%)';
                                pctChangeElem.className = 'text-sm font-medium ' + (pc >= 0 ? 'text-success' : 'text-error');
                            }
                        }
                    });
                }

                // Update MCX
                const mcxCards = document.querySelectorAll('#indices-mcx .card');
                if (data.mcx && mcxCards.length > 0) {
                    data.mcx.forEach(function (item, i) {
                        if (mcxCards[i]) {
                            const priceElem = mcxCards[i].querySelector('.text-lg.font-bold');
                            const pctChangeElem = mcxCards[i].querySelector('.text-sm.font-medium');

                            if (priceElem) {
                                priceElem.textContent = parseFloat(item.lp).toFixed(2);
                            }

                            if (pctChangeElem) {
                                const pc = parseFloat(item.pc);
                                pctChangeElem.textContent = '(' + (pc >= 0 ? '+' : '') + pc.toFixed(2) + '%)';
                                pctChangeElem.className = 'text-sm font-medium ' + (pc >= 0 ? 'text-success' : 'text-error');
                            }
                        }
                    });
                }
            }
        } catch (error) {
            console.debug('Price refresh error:', error);
        } finally {
            // Schedule next refresh only after current one completes (Recursive Fetching)
            setTimeout(refreshDashboardPrices, 500);
        }
    }

    async function updateTradingLots(newValue) {
        try {
            const response = await fetch('/api/settings/lots', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ lots: newValue })
            });

            const data = await response.json();
            if (response.ok) {
                console.log('Trading lots updated:', data);
                // Optional: Show a toast/notification
            } else {
                console.error('Failed to update lots:', data.error);
                alert('Error updating lots: ' + data.error);
                // Revert input value if possible (requires reference)
            }
        } catch (error) {
            console.error('Error in request:', error);
            alert('Failed to connect to server');
        }
    }

    // Data-Level Auto-Refresh (Recursive Fetch)
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Starting dashboard auto-refresh...');
        refreshDashboardPrices();
    });

</script>
{% endblock %}